#include <string.h>
#include <math.h>
#include <stdlib.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "driver/spi_master.h"
#include "esp_check.h"
#include "font.h"
#include "font_c64.h"
#include "font_picopixel.h"
#include "microarcade.h"
#include "disp.h"
#include "esp_rotary.h"



#define GPIO_BLINK	2


uint8_t	domy_buf[24][128] = {
	{ /* "frame_01" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_02" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_03" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_04" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_05" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_06" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_07" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x60, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_08" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x60, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_09" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_10" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_11" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_12" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_13" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_14" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xe0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_15" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb9,
	  0x7b, 0x79, 0x5f, 0x57, 0x7f, 0x79, 0x7b, 0x79,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xe0, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_16" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xe0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_17" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_18" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0x80, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_19" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xc0,
	  0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_20" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xc0, 0xe0,
	  0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_21" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_22" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_23" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_24" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 }
};


uint8_t	ball_buf[8] = {
	/* "ball" (8x8): vertical mapping, 64 pixels, 8 bytes */
	   0x3c, 0x7e, 0xff, 0xff, 0xff, 0xff, 0x7e, 0x3c };


typedef struct ball {
	int16_t	xpos;
	int16_t	ypos;
	int8_t	xvel;
	int8_t	yvel;
} ball_t;


#define MAX_BALLCNT 50
ball_t balls[MAX_BALLCNT] = { 0 };
int ballcnt = 10;



typedef struct menu_item {
	const char	*mi_text;
	void		(*mi_start_func)(void);
} menu_item_t;


void mod_rotarytest_start(void);
void mod_pong_single_start(void);
void mod_pong_multi_start(void);

#define MENU_ITEMCNT	14

menu_item_t	mitem[MENU_ITEMCNT] = {
	{ "Rotary Test", mod_rotarytest_start },
	{ "Bouncy Balls", NULL },
	{ "Pong", NULL },
	{ " single player", mod_pong_single_start },
	{ " two players", mod_pong_multi_start },
	{ "Clock", NULL },
	{ "Etch-a-Sketch", NULL },
	{ "Space Dodge", NULL },
	{ "Lander", NULL },
	{ "Bucket Catch", NULL },
	{ "Test2", NULL },
	{ "Test3", NULL },
	{ "Set Clock", NULL },
	{ "Test5", NULL }
};


#define MENU_LINEMAXLEN	16
#define MENU_LINECNT	8


void
app_main(void)
{
	esp_err_t			ret;
	gpio_config_t			gpioconf;
	rotary_config_t			rconf[ROTARY_CNT];
	uint8_t				mselidx;
	uint8_t				mdispidx;
	rotary_event_t			rev;
	disp_conf_t			dconf;
	int				i;
	char				displin[MENU_LINEMAXLEN];

	ret = ESP_OK;

	/* Set up onboard LED -- will blink on error */
	memset(&gpioconf, 0, sizeof(gpio_config_t));

	gpioconf.mode = GPIO_MODE_OUTPUT;
	gpioconf.intr_type = GPIO_INTR_DISABLE;
	gpioconf.pin_bit_mask = 1ULL << GPIO_BLINK;
	ret = gpio_config(&gpioconf);
	if(ret != ESP_OK) {
		printf("Could not config gpio\n");
		goto err_label;
		
	}

	/* Set up display */
	memset(&dconf, 0, sizeof(dconf));
	dconf.dc_pin_clk = 4;
	dconf.dc_pin_mosi = 5;
	dconf.dc_pin_reset = 6;
	dconf.dc_pin_dc = 7;
	dconf.dc_pin_cs = 15;
	dconf.dc_spi_hz = 10 * 1000 * 1000;

	ret = disp_init(&dconf);
	if(ret != ESP_OK)
		goto err_label;

	memset(rconf, 0, sizeof(rotary_config_t) * ROTARY_CNT);
	rconf[ROTARY_LEFT].rc_pin_a = 45;
	rconf[ROTARY_LEFT].rc_pin_b = 0;
	rconf[ROTARY_LEFT].rc_pin_button = 35;
	rconf[ROTARY_LEFT].rc_style = ROT_STYLE_BOUND;
	rconf[ROTARY_LEFT].rc_min = 0;
	rconf[ROTARY_LEFT].rc_max = MENU_ITEMCNT;
	rconf[ROTARY_LEFT].rc_start = 0;

	rconf[ROTARY_RIGHT].rc_pin_a = 21;
	rconf[ROTARY_RIGHT].rc_pin_b = 47;
	rconf[ROTARY_RIGHT].rc_pin_button = 48;
	rconf[ROTARY_RIGHT].rc_style = ROT_STYLE_BOUND;
	rconf[ROTARY_RIGHT].rc_min = 0;
	rconf[ROTARY_RIGHT].rc_max = MENU_ITEMCNT;
	rconf[ROTARY_RIGHT].rc_start = 0;


	if(rotary_config(rconf, ROTARY_CNT) != ESP_OK) {
		printf("Could not configure rotary encoders\n");
		goto err_label;
	}

	
	/* Enter main menu loop */
	mselidx = 0;
	while(1) {

		/* Redraw menu */
		mdispidx = (mselidx / MENU_LINECNT) * MENU_LINECNT;
		for(i = 0; i < MENU_LINECNT; ++i) {
			if(i >= MENU_ITEMCNT || i + mdispidx >= MENU_ITEMCNT)
				break;

			snprintf(displin, MENU_LINEMAXLEN, "%c%s",
			    mdispidx + i == mselidx ? '*' : ' ',
			    mitem[mdispidx + i].mi_text);

			puttext(curframe, displin, &font_c64, 0, i * 8);
		}

		sendswapcurframe();

		/* Wait for rotary event */
		if(xQueueReceive(rotary_event_queue, &rev, portMAX_DELAY)
		    != pdPASS)
			continue;

		if(rev.re_idx != ROTARY_LEFT)
			continue;

		switch(rev.re_type) {
		case ROT_EVENT_INCREMENT:
		case ROT_EVENT_DECREMENT:
			if(rev.re_value >=0 && rev.re_value < MENU_ITEMCNT)
				mselidx = rev.re_value;

			break;

		case ROT_EVENT_BUTTON_RELEASE:

			if(mitem[mselidx].mi_start_func)
				mitem[mselidx].mi_start_func();

			/* Not reached */

			break;

		default:
			break;

		}

	}

err_label:

	printf("Error: %s\n", esp_err_to_name(ret));

	while (1) {
       		gpio_set_level(GPIO_BLINK, 0);
		vTaskDelay(pdMS_TO_TICKS(100));
		gpio_set_level(GPIO_BLINK, 1);
		vTaskDelay(pdMS_TO_TICKS(100));
	}
}

	
#if 0


int idx = 0;

int xpos = 25;
int ypos = 0;
int xspeed = 1;
int yspeed = 1;

srand((unsigned int)xTaskGetTickCount());

ballcnt = 10;
for(int i = 0; i < ballcnt; ++i) {
	balls[i].xvel = rand() % 6;
	balls[i].ypos = rand() % 50;
}

int ydirchange;
while(1) {
	
	memset(curframe, 0, 1024);

//	puttext("hello, world", &font_c64, 0, 0);
//	puttext("hello, world", &font_picopixel, 0, 8);

	puttext("hello, world", &font_c64, ypos, 0);
	puttext("hello, world", &font_picopixel, 0, 50-ypos);

	blt(domy_buf[idx], 128, 32, xpos, ypos);
	
	xpos += xspeed;
	ypos += yspeed;
	
	if((xspeed > 0 && xpos >= 128 - 32) ||
	    (xspeed < 0 && xpos <= 0))
		xspeed = -xspeed;

	if((yspeed > 0 && ypos >= 64 - 32) ||
	    (yspeed < 0 && ypos <= 0)) {
		yspeed = -yspeed; 
	}

	for(int i = 0; i < ballcnt; ++i) {
		ball_t *b = &balls[i];
		b->xpos += b->xvel;
		if(b->xpos > 120) {
			b->xpos = 120 - (b->xpos - 120);
			b->xvel = -b->xvel;
		} else
		if(b->xpos < 0) {
			b->xpos = -b->xpos;
			b->xvel = -b->xvel;
		}
			


		ydirchange = 0;
		b->ypos += b->yvel;
		if(b->ypos >= 56) {
//			b->ypos = 56 - (b->ypos - 56) * .7;
			b->ypos = 56;
//printf("old yvel=%d\n", b->yvel);
			b->yvel = -b->yvel * .8;
//			b->yvel = -b->yvel * .6;
//printf("new yvel=%d\n", b->yvel);
			++ydirchange;
			if(abs(b->yvel) < 2) {
				b->ypos = 0;
				b->xpos = 0;
				b->xvel = rand() % 20;
				b->yvel = 0;
			}
		}

		blt(ball_buf, 8, 8, b->xpos, b->ypos);

		if(!ydirchange)
			b->yvel += 2;
//printf("yvel=%d, ypos=%d\n", b->yvel, b->ypos);
	}

	memset(&transact, 0, sizeof(spi_transaction_t));
	transact.length = 1024 * 8;
	transact.tx_buffer = curframe;
	ret = spi_device_transmit(devhand, &transact);
	if(ret != ESP_OK) {
		printf("Could not send data\n");
		goto err_label;
	}


	vTaskDelay(pdMS_TO_TICKS(100));
	++idx;
	if(idx > 23)
		idx = 0;
}




#endif




