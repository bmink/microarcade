#include <stdio.h>
#include <string.h>
#include <math.h>
#include <stdlib.h>
#include <esp_rotary.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "driver/spi_master.h"
#include "esp_check.h"
#include "font.h"
#include "font_c64.h"
#include "font_picopixel.h"


int
config_led_gpio(int pinnr)
{
	gpio_config_t	config;
	int		ret;

	memset(&config, 0, sizeof(gpio_config_t));

	config.mode = GPIO_MODE_OUTPUT;
	config.intr_type = GPIO_INTR_DISABLE;
	config.pin_bit_mask = 1ULL << pinnr;
	ret = gpio_config(&config);
	if(ret != ESP_OK) {
		printf("Could not config gpio\n");
		return ret;
		
	}



	return 0;
}


static const char *logtag = "rotary test";

#define GPIO_BLINK	2

#define SSD1309_default_memoryAddressingMode 0x00	 /** 0x00 = horizontal, 0x01 = vertical, 0x02 = page */
#define SSD1309_default_contrastControl 0xFF		 /** 0x00 - 0xFF */
#define SSD1309_default_multiplexRatio 0x3F			 /** 0x0F - 0x3F */
#define SSD1309_default_displayOffset 0x00			 /** 0x00 - 0x3F */
#define SSD1309_default_displayClockDivideRatio 0x80 /** 0x00 - 0xFF */
#define SSD1309_default_preChargePeriod 0x22		 /** 0x00 - 0xFF */
#define SSD1309_default_COMpinsHWconfig 0x12		 /** 0x02 - 0x12 */
#define SSD1309_default_VCOMHdeselectLevel 0x40		 /** 0x00 - 0x7F */

#define SSD1309_setContrastControl 0x81			/** set contrast control */
#define SSD1309_followRAMcontent 0xA4			/** resume to RAM content display */
#define SSD1309_allPixelsOn 0xA5				/** all pixels on */
#define SSD1309_inversionOff 0xA6				/** normal display */
#define SSD1309_inversionOn 0xA7				/** inverted display */
#define SSD1309_pwrOff 0xAE						/** power off */
#define SSD1309_pwrOn 0xAF						/** power on */
#define SSD1309_nop 0xE3						/** nop */
#define SSD1309_setCommandLock 0xFD				/** set command lock */
#define SSD1309_contHScrollSetupRight 0x26		/** continuous horizontal scroll setup right */
#define SSD1309_contHScrollSetupLeft 0x27		/** continuous horizontal scroll setup left */
#define SSD1309_contVHScrollSetupRight 0x29		/** continuous vertical and horizontal scroll setup right */
#define SSD1309_contVHScrollSetupLeft 0x2A		/** continuous vertical and horizontal scroll setup left */
#define SSD1309_deactivateScroll 0x2E			/** deactivate scroll */
#define SSD1309_activateScroll 0x2F				/** activate scroll */
#define SSD1309_setVScrollArea 0xA3				/** set vertical scroll area */
#define SSD1309_contentScrollSetupRight 0x2C	/** content scroll setup right */
#define SSD1309_contentScrollSetupLeft 0x2D		/** content scroll setup left */
#define SSD1309_setLowCSAinPAM 0x00				/** set lower column start address in page addressing mode */
#define SSD1309_setHighCSAinPAM 0x10			/** set higher column start address in page addressing mode */
#define SSD1309_setMemoryAddressingMode 0x20	/** set memory addressing mode */
#define SSD1309_setColumnAddress 0x21			/** set column address */
#define SSD1309_setPageAddress 0x22				/** set page address */
#define SSD1309_setPSAinPAM 0xB0				/** set page start address in page addressing mode */
#define SSD1309_setDisplayStartLine 0x40		/** set display start line */
#define SSD1309_setSegmentMapReset 0xA0			/** set segment map reset */
#define SSD1309_setSegmentMapFlipped 0xA1		/** set segment map flipped */
#define SSD1309_setMultiplexRatio 0xA8			/** set multiplex ratio */
#define SSD1309_setCOMoutputNormal 0xC0			/** set COM output normal */
#define SSD1309_setCOMoutputFlipped 0xC8		/** set COM output flipped */
#define SSD1309_setDisplayOffset 0xD3			/** set display offset */
#define SSD1309_setCOMpinsHWconfig 0xDA			/** set COM pins hardware configuration */
#define SSD1309_setGPIO 0xDC					/** set GPIO */
#define SSD1309_setDisplayClockDivideRatio 0xD5 /** set display clock divide ratio */
#define SSD1309_setPreChargePeriod 0xD9			/** set pre-charge period */
#define SSD1309_setVCOMHdeselectLevel 0xDB		/** set VCOMH deselect level */



uint8_t	domy_buf[24][128] = {
	{ /* "frame_01" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_02" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_03" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_04" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_05" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_06" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_07" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x60, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_08" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x60, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_09" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_10" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_11" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0x60, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_12" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_13" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xf0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_14" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb8,
	  0x7a, 0x78, 0x5f, 0x57, 0x7f, 0x78, 0x7a, 0x78,
	  0xbf, 0x1f, 0x0f, 0x04, 0xe0, 0xe0, 0xf0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_15" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xb9,
	  0x7b, 0x79, 0x5f, 0x57, 0x7f, 0x79, 0x7b, 0x79,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xe0, 0xe0, 0xf0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x80, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_16" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xe0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_17" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_18" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x00, 0x80, 0xc0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc1, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_19" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xc0,
	  0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_20" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0xc0, 0xc0, 0xe0,
	  0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x03,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_21" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xe0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe0, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_22" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe1, 0xc3, 0x07,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_23" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 },

	{ /* "frame_24" (32x32): vertical mapping */
	  0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xf8,
	  0xf0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xf0,
	  0xf8, 0xf8, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x04, 0x0e, 0x1f, 0x3f, 0xbd,
	  0x7f, 0x7d, 0x5f, 0x57, 0x7f, 0x7d, 0x7f, 0x7d,
	  0xbf, 0x1f, 0x0f, 0x04, 0x00, 0x80, 0xc0, 0xe0,
	  0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0x00, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f,
	  0xff, 0x7f, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff,
	  0x3f, 0xfe, 0xfc, 0xf8, 0xf0, 0xe3, 0xc7, 0x0f,
	  0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xf8, 0x00,
	  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
	  0x3f, 0x5f, 0x3e, 0x40, 0x3d, 0x7f, 0x7f, 0x01,
	  0x7e, 0x7f, 0x7f, 0x7f, 0x7f, 0x1f, 0x7f, 0x70,
	  0x7f, 0x7f, 0x3f, 0x1f, 0x0f, 0x07, 0x03, 0x00 }
};

spi_device_handle_t		devhand;



#define FRAMESIZ	1024

uint8_t		frame1[FRAMESIZ];
uint8_t		frame2[FRAMESIZ];

uint8_t		*curframe = frame1;

SemaphoreHandle_t	sendframe_mutex;
uint8_t			*sendframe = NULL;

TaskHandle_t	frame_sender_task;


static void
frame_sender_loop(void *arg)
{
	int			ret;
	spi_transaction_t	transact;
	int			had_frame_to_send;

	while(ulTaskNotifyTake(pdTRUE, portMAX_DELAY)) {
		had_frame_to_send = 0;
		xSemaphoreTake(sendframe_mutex, portMAX_DELAY);
		if(sendframe == NULL) {
			goto next_iter;
		}

		/* Only we can set sendframe back to NULL, and the writer
		 * will not notify as long as it it not NULL, so
		 * it's safe to release the mutex here */
		xSemaphoreGive(sendframe_mutex);

printf("Sending frame\n");
		memset(&transact, 0, sizeof(spi_transaction_t));
		transact.length = 1024 * 8;
		transact.tx_buffer = sendframe;
		ret = spi_device_transmit(devhand, &transact);
		if(ret != ESP_OK) {
			printf("Could not send data\n");
		}

		++had_frame_to_send;	
		xSemaphoreTake(sendframe_mutex, portMAX_DELAY);
		sendframe = NULL;

next_iter:
		xSemaphoreGive(sendframe_mutex);

		if(!had_frame_to_send)
			printf("Was woken up but nothing to send!\n");
		
	}
	
}


void
clearcurframe(void)
{
	memset(curframe, 0, FRAMESIZ);
}


void
sendswapcurframe(void)
{
	xSemaphoreTake(sendframe_mutex, portMAX_DELAY);
	if(sendframe != NULL) {
		printf("Dropping frame!\n");
	} else {
		sendframe = curframe;
		if(curframe == frame1)
			curframe = frame2;
		else
			curframe = frame1;
		

	}
	xSemaphoreGive(sendframe_mutex);
	xTaskNotifyGive(frame_sender_task);
	clearcurframe();

}

void
blt(uint8_t *buf, uint32_t buflen, int8_t spritewidth, int xpos, int ypos)
{
	int	x;
	int	y;
	int	ybase;	
	int	ymod;	
	uint8_t	*framecur;
	uint8_t	*spritecur;
	int	i;
	uint8_t	byte;

	/* Screen buffer is vertically mapped so for y positions that aren't
	 * divisible by 8, we have to do some bit shifting */
		
	ybase = ypos / 8;
	ymod = ypos % 8;

	spritecur = buf;
	framecur = curframe + 128 * ybase + xpos;
	for(i = 0, x = xpos, y = ybase; i < buflen + spritewidth; ++i) {

		if(x < 128 && y < 8) {

			if(i < buflen)
				byte = *spritecur << ymod;
			else	/* Overflow row */
				byte = 0;

			if(i >= spritewidth)
				byte |= *(spritecur - spritewidth) >> (8 - ymod);

			*framecur |= byte;
		}

		++x;
		if(i > 0 && ((i+1) % spritewidth) == 0) {
			x = xpos;
			++y;
			framecur = curframe + 128 * y + xpos;
		} else
			++framecur;

		++spritecur;
	}


}


void
puttext(const char *text, const font_t *fo, int x, int y)
{
	const char 	*ch;
	int		xpos;
	int		ypos;
	uint8_t		*bitmap;
	font_char_t	*fch;

	xpos = x;
	ypos = y;

	for(ch = text; *ch; ++ch) {
		if(*ch == '\n') {
			xpos = x;
			ypos += fo->fo_line_height;
			
			continue;
		}

		if(*ch < fo->fo_ascii_min || *ch > fo->fo_ascii_max) {
			/* Unsupported char */
			fch = &fo->fo_chars['?' - fo->fo_ascii_min];
		} else {
			fch = &fo->fo_chars[*ch - fo->fo_ascii_min];
		}

		bitmap = fo->fo_bitmap + fch->fc_bitmap_offs;

		blt(bitmap, fch->fc_bitmap_siz, fch->fc_width,
		    xpos, ypos);

		xpos += fch->fc_width;

	}
}


uint8_t	ball_buf[8] = {
	/* "ball" (8x8): vertical mapping, 64 pixels, 8 bytes */
	   0x3c, 0x7e, 0xff, 0xff, 0xff, 0xff, 0x7e, 0x3c };


typedef struct ball {
	int16_t	xpos;
	int16_t	ypos;
	int8_t	xvel;
	int8_t	yvel;
} ball_t;


#define MAX_BALLCNT 50
ball_t balls[MAX_BALLCNT] = { 0 };
int ballcnt = 10;


void menu_loop(void);



void
app_main(void)
{
	esp_err_t			ret;
	spi_bus_config_t		spiconf;
	spi_device_interface_config_t	devconf;
	spi_transaction_t		transact;

	ret = ESP_OK;

	ESP_GOTO_ON_ERROR(config_led_gpio(GPIO_BLINK), err_label,
	    logtag, "Could not configure LED on pin %d", GPIO_BLINK);

	memset(&spiconf, 0, sizeof(spi_bus_config_t));
	spiconf.sclk_io_num = 17;
	spiconf.mosi_io_num = 18;

	spiconf.quadwp_io_num = -1;
	spiconf.quadhd_io_num = -1;

	ret = spi_bus_initialize(SPI2_HOST, &spiconf, SPI_DMA_CH_AUTO);
	if(ret != ESP_OK) {
		printf("Could not initialize SPI bus\n");
		goto err_label;
	}

	memset(&devconf, 0, sizeof(spi_device_interface_config_t));
	devconf.clock_speed_hz = 10000000;
	devconf.spics_io_num = 46;
	devconf.queue_size = 16;
	
	ret = spi_bus_add_device(SPI2_HOST, &devconf, &devhand);
	if(ret != ESP_OK) {
		printf("Could not add device\n");
		goto err_label;
	}

	config_led_gpio(3);	/* DC */
	config_led_gpio(8);	/* RESET */


	gpio_set_level(8, 0); /* Reset */
	vTaskDelay(pdMS_TO_TICKS(100));
	gpio_set_level(8, 1); 


	uint8_t cmds[] = {
		0x20, 0x00,	/* Horizontal addressing mode */
		//0xa5,		/* All pixels on */
		//0xa7,		/* Inverse */
		0xaf		/* Display on */
	};

	gpio_set_level(3, 0); /* Command */

	memset(&transact, 0, sizeof(spi_transaction_t));
	transact.length = sizeof(cmds) * 8;
	transact.tx_buffer = cmds;

	ret = spi_device_transmit(devhand, &transact);
	if(ret != ESP_OK) {
		printf("Could not send data\n");
		goto err_label;
	}

	gpio_set_level(3, 1); /* Data */


	ret = xTaskCreate(frame_sender_loop, "frame_sender_loop",
	    4096, NULL, 20, &frame_sender_task);
	if(ret != pdPASS)
		goto err_label;

	sendframe_mutex = xSemaphoreCreateMutex();

	sendswapcurframe();

	menu_loop();


int idx = 0;

int xpos = 25;
int ypos = 0;
int xspeed = 1;
int yspeed = 1;

srand((unsigned int)xTaskGetTickCount);

ballcnt = 10;
for(int i = 0; i < ballcnt; ++i) {
	balls[i].xvel = rand() % 6;
	balls[i].ypos = rand() % 50;
}

int ydirchange;
while(1) {
	
	memset(curframe, 0, 1024);

//	puttext("hello, world", &font_c64, 0, 0);
//	puttext("hello, world", &font_picopixel, 0, 8);

	puttext("hello, world", &font_c64, ypos, 0);
	puttext("hello, world", &font_picopixel, 0, 50-ypos);

	blt(domy_buf[idx], 128, 32, xpos, ypos);
	
	xpos += xspeed;
	ypos += yspeed;
	
	if((xspeed > 0 && xpos >= 128 - 32) ||
	    (xspeed < 0 && xpos <= 0))
		xspeed = -xspeed;

	if((yspeed > 0 && ypos >= 64 - 32) ||
	    (yspeed < 0 && ypos <= 0)) {
		yspeed = -yspeed; 
	}

	for(int i = 0; i < ballcnt; ++i) {
		ball_t *b = &balls[i];
		b->xpos += b->xvel;
		if(b->xpos > 120) {
			b->xpos = 120 - (b->xpos - 120);
			b->xvel = -b->xvel;
		} else
		if(b->xpos < 0) {
			b->xpos = -b->xpos;
			b->xvel = -b->xvel;
		}
			


		ydirchange = 0;
		b->ypos += b->yvel;
		if(b->ypos >= 56) {
//			b->ypos = 56 - (b->ypos - 56) * .7;
			b->ypos = 56;
//printf("old yvel=%d\n", b->yvel);
			b->yvel = -b->yvel * .8;
//			b->yvel = -b->yvel * .6;
//printf("new yvel=%d\n", b->yvel);
			++ydirchange;
			if(abs(b->yvel) < 2) {
				b->ypos = 0;
				b->xpos = 0;
				b->xvel = rand() % 20;
				b->yvel = 0;
			}
		}

		blt(ball_buf, 8, 8, b->xpos, b->ypos);

		if(!ydirchange)
			b->yvel += 2;
//printf("yvel=%d, ypos=%d\n", b->yvel, b->ypos);
	}

	memset(&transact, 0, sizeof(spi_transaction_t));
	transact.length = 1024 * 8;
	transact.tx_buffer = curframe;
	ret = spi_device_transmit(devhand, &transact);
	if(ret != ESP_OK) {
		printf("Could not send data\n");
		goto err_label;
	}


	vTaskDelay(pdMS_TO_TICKS(100));
	++idx;
	if(idx > 23)
		idx = 0;
}


err_label:

	printf("Error: %s\n", esp_err_to_name(ret));

	while (1) {
       		gpio_set_level(GPIO_BLINK, 0);
		vTaskDelay(pdMS_TO_TICKS(100));
		gpio_set_level(GPIO_BLINK, 1);
		vTaskDelay(pdMS_TO_TICKS(100));
	}
}




typedef struct menu_item {
	const char	*mi_text;
	void		(*mi_start_func)(void);
} menu_item_t;

#define MENU_ITEMCNT	8

menu_item_t	mitem[MENU_ITEMCNT] = {
	{ "Rotary Test", NULL },
	{ "Bouncy Balls", NULL },
	{ "Clock", NULL },
	{ "Etch-a-Sketch", NULL },
	{ "Space Dodge", NULL },
	{ "Lander", NULL },
	{ "Test1", NULL },
	{ "Test2", NULL }
};

uint8_t	mselidx;
uint8_t	mdispidx;


#define MENU_LINEMAXLEN	16
#define MENU_LINECNT	6


void
menu_loop(void)
{
	int	i;
	char	displin[MENU_LINEMAXLEN];
	int	dir;

	dir = 1;
	while(1) {

		/* Draw menu */
		for(i = 0; i < MENU_LINECNT; ++i) {
			if(i >= MENU_ITEMCNT || i + mdispidx >= MENU_ITEMCNT)
				break;

			snprintf(displin, MENU_LINEMAXLEN, "%c%s",
			    mdispidx + i == mselidx ? '*' : ' ',
			    mitem[mdispidx + i].mi_text);

			puttext(displin, &font_c64, 0, i * 8);

		}

		sendswapcurframe();
		vTaskDelay(pdMS_TO_TICKS(1000));

		if(dir < 0 && mselidx == 0)
			dir = 1;
		else
		if(dir > 0 && mselidx == MENU_ITEMCNT - 1)
			dir = -1;
		else
			mselidx += dir;

		if(mselidx < mdispidx) 
			mdispidx -= MENU_LINECNT;
		else
		if(mselidx >= mdispidx + MENU_LINECNT) 
			mdispidx += MENU_LINECNT;
		
	}
	
}
